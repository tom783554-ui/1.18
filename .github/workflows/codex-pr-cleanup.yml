name: Codex PR Cleanup

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  delete-codex-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Delete merged Codex branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;

            if (!pr.merged) {
              core.info("PR not merged; skipping.");
              return;
            }

            const authorLogin = pr.user?.login || "";
            const headRef = pr.head?.ref || "";
            const title = pr.title || "";
            const isCodex = /codex|openai/i.test(authorLogin)
              || /codex/i.test(headRef)
              || /codex/i.test(title);

            if (!isCodex) {
              core.info("PR does not appear to be from Codex/OpenAI; skipping.");
              return;
            }

            const headRepoFullName = pr.head?.repo?.full_name || "";
            const baseRepoFullName = pr.base?.repo?.full_name || "";

            if (headRepoFullName !== baseRepoFullName) {
              core.info("PR head repo differs from base repo; skipping branch deletion.");
              return;
            }

            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `heads/${headRef}`,
              });
              core.info(`Deleted branch ${headRef}.`);
            } catch (error) {
              core.warning(`Unable to delete branch: ${error.message}`);
            }
